{% extends "base.html" %}

<!-- Navbar Button -->
{% block topNavbar %}
<a class="nav-link to-top" href="#">Home
  <span class="sr-only">(current)</span>
</a>
{% endblock topNavbar %}

<!-- Subtitle -->
{% block secondtitle %}
<h4 class="mt-3 text-muted">Choose a style image</h4>
{% endblock secondtitle %}

<!-- Page Content -->
{% block main %}
	 <main class="container mt-3">
	 	<!-- Style image section -->
      <section class="style-image-section">
      	  <div class="card card-default">
      	  	<div class="card-header">Styles</div>
      	  	<div class="container-fluid card-body" style="max-height: 450px;overflow-y: scroll;">
      	  		<div class="row mt-2">
		          <div class="col-lg-4">
		            <div id="mirror" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/mirror.jpg') }}" alt="Mirror">
		            </div>
		          </div>
		          <div class="col-lg-4">
		            <div id="udnie" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/udnie.jpg') }}" alt="Udnie">
		            </div>
		          </div>
		          <div class="col-lg-4">
		            <div id="la_muse" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/la_muse.jpg') }}" alt="La_muse">
		            </div>
		          </div>
	            </div>
      	  		<div class="row mt-2">
		          <div class="col-lg-4">
		            <div id="chinese" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/chinese.jpg') }}" alt="Chinese">
		            </div>
		          </div>
		          <div class="col-lg-4">
		            <div id="mountain_water" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/mountain_water.jpg') }}" alt="MountainWater">
		            </div>
		          </div>
		          <div class="col-lg-4">
		            <div id="zhangdaqian" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/zhangdaqian.jpg') }}" alt="Zhangdaqian">
		            </div>
		          </div>    
		        </div>
		        
	            <div class="row mt-2">
		          <div class="col-lg-4">
		            <div id="des_glaneuses" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/des_glaneuses.jpg') }}" alt="Des_glaneuses">
		            </div>
		          </div>
		          <div class="col-lg-4">
		            <div id="wave_crop" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/wave_crop.jpg') }}" alt="Wave_crop">
		            </div>
		          </div>
		          <div class="col-lg-4">
		            <div id="starry_night" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/starry_night.jpg') }}" alt="Starry_night">
		            </div>
		          </div>
	            </div>
	            <div class="row mt-2">
		          <div class="col-lg-4">
		            <div id="monalisa" class="img-item">
		              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/monalisa.jpg') }}" alt="Monalisa">
		            </div>
		          </div>
	            </div>
	        </div>
          </div>
        </section>
        <div class="row mt-4">
          <div class="col-lg-12 text-center">
            <h4 class="text-muted" id="selected-style">You choosed: </h4>
          </div>
        </div>
        <HR>
        <!--  Form upload section -->
        <div class="row mt-4">
          <div class="col-lg-12 text-center">
            <h4 class="text-muted">Upload your image</h4>
          </div>
        </div>
        <form action="javascript:;" id="image-submit" onsubmit="return makeForm(this);" method=post enctype=multipart/form-data>
          <div class="row mt-3">
            <div class="col-lg-3 text-center">
              <input name="file" class="form-control" type="file" id="img-input" accept="image/*">
            </div>
            <div class="col-lg-6">
              <img id="img-preview" class="img-fluid mx-auto" src="" alt="your image" />
            </div>
          </div>
          <div class="d-flex justify-content-center">
            <div class="row">
              <button type="submit" onclick="return makeForm(this);" id="img-upload" class="btn btn-primary mt-4">Go!</button>
            </div>
          </div>
        </form>
    </main>
    <!--  Result section -->
    <section class="result-section container mt-5 d-none">
      <div class="row">
        <div class="col-lg-12 mb-5">
          <HR>
          <h4 class="text-muted text-center mt-5" id="result-state">Wait a minute</h4>
          <div class="loader text-center mt-5 mx-auto"></div>
          <img id="img-output" class="img-fluid d-none mx-auto" src="" alt="your image" />
        </div>        
      </div>
    </section>

    <!--  To top button -->
    <a class="rounded to-top" id="scroll-to-top" href="#page-top">
      <i class="fa fa-angle-up"></i>
    </a>
{% endblock main %}

{% block script %}
<script type="text/javascript">
	"use strict";
	var selectedStyleImage;

	function makeForm(e) {
		// Prevent default form behavior
		event.preventDefault();
		// Check the file is not empty and a style has been selected
		if($("#img-input").prop("files")[0] != undefined && selectedStyleImage != undefined) {
			var form = new FormData();
			form.append("file", $("#img-input").prop("files")[0]);
        	// NEED TO CHANGE IN FUTURE
        	form.append("style", selectedStyleImage);
        	alert(form);
			sendData(form);
			// Show the result section
			$(".result-section").toggleClass("d-none", false);
			$("#result-state").text("Wait a minute!");
			$(".loader").toggleClass("d-none", false);
			toggleOutputImage(false);
			// Scroll to the result section
			$('html, body').animate({
			                scrollTop: $(".result-section").offset().top
			            }, 1000, //Millisecond
			            "easeInQuint");
		} else if(selectedStyleImage == undefined) {
				alert('no style selected');
		} else {
			alert('no uploaded');
		}
	}

	// Read the image user choosed to upload
	function readURL(input) {
		if (input.files && input.files[0]) {
			var reader = new FileReader();
		    reader.onload = function(e) {
		    	$("#img-preview").css("visibility", "visible");
		    	$("#img-preview").attr("src", e.target.result);
		    }
		    reader.readAsDataURL(input.files[0]);
		}
	}

	// Submit form data
	function sendData(formdata) {
		alert('send data');
		$.ajax({
		    url: "/upload_image",
		    data: formdata,
		    type: "POST",
		    contentType: false,
		    processData: false,
		    async: true,
            cache: false,
            headers: { "cache-control": "no-cache" },
		    success: function(response) {
		        console.log('json return successful');
		        console.log(typeof(response));
		        var json_data = JSON.parse(response);
		        if (json_data["error"]) { // has error
		        	displayError(json_data["error"]);
		    	} else { // success
		    		setImage(JSON.parse(response));
		    	}
		    },
		    error: function(error) {
		        console.log("fail");
		        console.log(error);
		        alert('fail');
		        alert(error.responseText);
		    }
		});
	};

	// Set image while the request is success
	function displayError(data) {
		$(".loader").toggleClass("d-none", true);
		$("#result-state").text(data);
	}

	// Set image while the request is success
	function setImage(data) {
		$("#result-state").text("Success!");
		$(".loader").toggleClass("d-none", true);
		$("#img-output").attr("src","data:image/jpeg;base64," + data["image"]);
		$("#img-output").css("visibility", "visible");
		toggleOutputImage(true);
	}

	// Set image output display or not
	function toggleOutputImage(turnon) {
		if(turnon) {
			$("#img-output").toggleClass("d-block", true);
			$("#img-output").toggleClass("d-none", false);
		}
		else {
			$("#img-output").toggleClass("d-block", false);
			$("#img-output").toggleClass("d-none", true);
		}

	}

	// Load this part while the DOM is ready
	$(function() {
		// Listen to the upload image button
		$("#img-input").change(function() {
			readURL(this);
		});
		// Clean the former selected image
		$("#img-input").click(function() {
			$("#img-preview").css("visibility", "hidden");
			$("#img-input").prop("value", "");
			$("#img-output").attr("src","");
			toggleOutputImage(false);
			$(".result-section").toggleClass("d-none", true);
		});

		// Listen to the style image selected event
		$(".style-image").click(function() {
	    	$(".style-image").removeClass("item-onclick");
	    	$(this).addClass("item-onclick");
	    	var selectedId = $(this).parent(".img-item").attr('id');
	    	$("#selected-style").text("You choosed: " + selectedId);
	    	selectedStyleImage = selectedId;
	  	});

		// To top button
	  	$(".to-top").click(function() {
	    	$('html, body').animate({
	            scrollTop: $("#page-top").offset().top
	        }, 1000, 
	        "easeInOutExpo");
	    	return false;
	  	});

	  	$(".to-top").click(function() {
	    	$('html, body').animate({
	            scrollTop: $("#page-top").offset().top
	        }, 1000, 
	        "easeInOutExpo");
	    	return false;
	  	});
	  	// Display the to top button
	  	$(document).scroll(function() {
	    	var scrollDistance = $(this).scrollTop();
	    	if (scrollDistance > 100) {
	      		$('#scroll-to-top').fadeIn();
	    	} else {
	      	$('#scroll-to-top').fadeOut();
	    	}
	  	});
	}); 
</script>
{% endblock script %}