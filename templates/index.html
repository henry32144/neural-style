{% extends "base.html" %}

{% block topNavbar %}
<a class="nav-link to-top" href="#">Home
  <span class="sr-only">(current)</span>
</a>
{% endblock topNavbar %}


{% block secondtitle %}
<h4 class="mt-3 text-muted">Choose an image</h4>
{% endblock secondtitle %}


{% block main %}
	 <main class="container mt-5">
      <div class="row style-image-section">
          <div class="col-lg-4">
            <div id="img-bamboo" class="img-item">
              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/bamboo.jpg') }}" alt="Bamboo">
            </div>
          </div>
          <div class="col-lg-4">
            <div id="img-misty-mood" class="img-item">
              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/misty-mood.jpg') }}" alt="Mistymood">
            </div>
          </div>
          <div class="col-lg-4">
            <div id="img-wave" class="img-item">
              <img class="img-thumbnail style-image" src="{{url_for('static', filename='img/wave.jpg') }}" alt="Wave">
            </div>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-lg-12 text-center">
            <h4 class="text-muted" id="selected-style">You choosed: </h4>
          </div>
        </div>
        <HR>
        <div class="row mt-4">
          <div class="col-lg-12 text-center">
            <h4 class="text-muted">Upload your image</h4>
          </div>
        </div>
        <form action="javascript:;" id="image-submit" onsubmit="return makeForm(this);" method=post enctype=multipart/form-data>
          <div class="row mt-3">
            <div class="col-lg-3 text-center">
              <input name="file" class="form-control" type="file" id="img-input" accept="image/*">
            </div>
            <div class="col-lg-6">
              <img id="img-preview" class="img-fluid" src="" alt="your image" />
            </div>
          </div>
          <div class="d-flex justify-content-center">
            <div class="row">
              <button type="submit" onclick="return makeForm(this);" id="img-upload" class="btn btn-primary mt-4">Go!</button>
            </div>
          </div>
        </form>
    </main>
    <section class="result-section container mt-5 d-none">
      <div class="row">
        <div class="col-lg-12 mb-5">
          <HR>
          <h4 class="text-muted text-center mt-5">Wait a minute</h4>
          <img id="img-output" class="img-fluid d-block mx-auto d-none" src="" alt="your image" />
        </div>        
      </div>
    </section>

    <a class="rounded to-top" id="scroll-to-top" href="#page-top">
      <i class="fa fa-angle-up"></i>
    </a>
{% endblock main %}

{% block script %}
<script type="text/javascript">
		"use strict";
		var selectedStyleImage;
		function makeForm(e) {
			event.preventDefault();
			if($("#img-input").prop("files")[0] != undefined && selectedStyleImage != undefined) {
			  var form = new FormData();
			  form.append("file", $("#img-input").prop("files")[0]);
			  sendData(form);
			  $(".result-section").removeClass("d-none");
			  $('html, body').animate({
			                  scrollTop: $(".result-section").offset().top
			              }, 1000, "easeInQuint");
			} else if(selectedStyleImage == undefined) {
			  alert('no style selected');
			} else {
			  alert('no uploaded');
			}
		};
		function readURL(input) {

		  if (input.files && input.files[0]) {
		    var reader = new FileReader();

		    reader.onload = function(e) {
		      $("#img-preview").css("visibility", "visible");
		      $("#img-preview").attr("src", e.target.result);
		    }

		    reader.readAsDataURL(input.files[0]);
		  }
		}

		function sendData(formdata) {
		alert('send data');
		  $.ajax({
		    url: "/upload_image",
		    data: formdata,
		    type: "POST",
		    contentType: false,
		    processData: false,
		    async: true,
            cache: false,
            headers: { "cache-control": "no-cache" },
		    success: function(response) {
		              console.log('success');
		              console.log(typeof(response));
		              alert('success');
		              setImage(JSON.parse(response));
		              
		          },
		          error: function(error) {
		              console.log("fail");
		              console.log(error);
		              alert('fail');
		              alert(error.responseText);
		          }
		  });
		  return false;
		};

		function setImage(data) {
		  $("#img-output").removeClass("d-none");
		  $("#img-output").attr("src","data:image/jpeg;base64," + data["image"]);

		};
	$(function() {
	  $("#img-input").change(function() {
	    readURL(this);
	  });

	  $(".style-image").click(function() {
	    $(".style-image").removeClass("item-onclick");
	    $(this).addClass("item-onclick");
	    var selectedId = $(this).parent(".img-item").attr('id');
	    $("#selected-style").text("You choosed: " + selectedId);
	    selectedStyleImage = selectedId;
	  });


	  $(".to-top").click(function() {
	    $('html, body').animate({
	                      scrollTop: $("#page-top").offset().top
	                  }, 1000, "easeInOutExpo");
	    return false;
	  });

	  $(document).scroll(function() {
	    var scrollDistance = $(this).scrollTop();
	    if (scrollDistance > 100) {
	      $('#scroll-to-top').fadeIn();
	    } else {
	      $('#scroll-to-top').fadeOut();
	    }
	  });

	}); 
</script>
{% endblock script %}